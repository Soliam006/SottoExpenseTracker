<div class="p-4 sm:p-6 lg:p-8">
  @if (project(); as p) {
    <div class="space-y-8">
      <!-- Header: Back link and actions -->
      <div class="flex justify-between items-center">
        <a routerLink="/projects" class="flex items-center text-indigo-600 hover:text-indigo-800 font-medium group">
          <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5 mr-2 transition-transform group-hover:-translate-x-1" viewBox="0 0 20 20" fill="currentColor">
            <path fill-rule="evenodd" d="M12.707 5.293a1 1 0 010 1.414L9.414 10l3.293 3.293a1 1 0 01-1.414 1.414l-4-4a1 1 0 010-1.414l4-4a1 1 0 011.414 0z" clip-rule="evenodd" />
          </svg>
          Back to Projects
        </a>
        <div class="flex space-x-3">
          <button (click)="openEditModal()" class="flex items-center bg-white text-gray-700 px-4 py-2 rounded-lg shadow-md border border-gray-300 hover:bg-gray-50 transition-colors duration-200">
            Edit
          </button>
          <button (click)="openDeleteModal()" class="flex items-center bg-red-600 text-white px-4 py-2 rounded-lg shadow-md hover:bg-red-700 transition-colors duration-200">
            Delete
          </button>
        </div>
      </div>

      <!-- Project Info Card -->
      <div class="bg-white rounded-lg shadow-lg overflow-hidden">
        @if (p.imageUrl) {
          <img [src]="p.imageUrl" [alt]="p.name" class="h-64 w-full object-cover">
        }
        <div class="p-6">
          <h2 class="text-3xl font-bold text-gray-800 mb-4">{{ p.name }}</h2>
          <div class="grid grid-cols-1 md:grid-cols-3 gap-4 text-gray-600">
            <p><span class="font-medium text-gray-800">Client:</span> {{ p.client }}</p>
            <p><span class="font-medium text-gray-800">Address:</span> {{ p.address }}</p>
            <p><span class="font-medium text-gray-800">Mobile:</span> {{ p.mobile }}</p>
          </div>
        </div>
      </div>

      <!-- Entries Section -->
      <div>
        <div class="flex justify-between items-baseline mb-4">
            <h3 class="text-2xl font-bold text-gray-800">Entries for this Project</h3>
            <p class="text-lg font-semibold text-indigo-600">Total: {{ totalExpenses() | currency }}</p>
        </div>
        <div class="bg-white rounded-lg shadow-md overflow-x-auto">
          <table class="w-full text-left">
            <thead class="bg-gray-50">
              <tr>
                <th class="p-4 font-semibold text-sm text-gray-600">Date</th>
                <th class="p-4 font-semibold text-sm text-gray-600">Type</th>
                <th class="p-4 font-semibold text-sm text-gray-600">Description</th>
                <th class="p-4 font-semibold text-sm text-gray-600 text-right">Amount</th>
              </tr>
            </thead>
            <tbody class="divide-y divide-gray-200">
              @for (entry of projectEntries(); track entry.id) {
                <tr>
                  <td class="p-4 whitespace-nowrap">{{ entry.date }}</td>
                  <td class="p-4 whitespace-nowrap">
                    <span [class]="entry.type === 'receipt' ? 'bg-blue-100 text-blue-800' : 'bg-green-100 text-green-800'" class="px-2 inline-flex text-xs leading-5 font-semibold rounded-full capitalize">{{ entry.type }}</span>
                  </td>
                  <td class="p-4 whitespace-nowrap text-gray-800">{{ entry.description }}</td>
                  <td class="p-4 whitespace-nowrap text-right font-medium text-gray-900">{{ entry.price | currency }}</td>
                </tr>
              } @empty {
                <tr>
                  <td colspan="4" class="text-center p-8 text-gray-500">No entries found for this project.</td>
                </tr>
              }
            </tbody>
          </table>
        </div>
      </div>
    </div>
  
    <!-- Edit Project Modal -->
    @if (isEditModalOpen()) {
      <div class="fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50 animate-fade-in-fast">
        <div class="bg-white rounded-lg shadow-2xl p-8 w-full max-w-md mx-4" (click)="$event.stopPropagation()">
          <h3 class="text-2xl font-bold mb-6">Edit Project</h3>
          <form [formGroup]="projectForm" (ngSubmit)="saveProject()">
            <div class="space-y-4">
              <div>
                <label for="name" class="block text-sm font-medium text-gray-700">Project Name</label>
                <input id="name" type="text" formControlName="name" class="mt-1 block w-full border border-gray-300 rounded-md shadow-sm py-2 px-3 focus:outline-none focus:ring-indigo-500 focus:border-indigo-500">
              </div>
              <div>
                <label for="client" class="block text-sm font-medium text-gray-700">Client</label>
                <input id="client" type="text" formControlName="client" class="mt-1 block w-full border border-gray-300 rounded-md shadow-sm py-2 px-3 focus:outline-none focus:ring-indigo-500 focus:border-indigo-500">
              </div>
              <div>
                <label for="address" class="block text-sm font-medium text-gray-700">Address</label>
                <input id="address" type="text" formControlName="address" class="mt-1 block w-full border border-gray-300 rounded-md shadow-sm py-2 px-3 focus:outline-none focus:ring-indigo-500 focus:border-indigo-500">
              </div>
              <div>
                <label for="mobile" class="block text-sm font-medium text-gray-700">Mobile</label>
                <input id="mobile" type="text" formControlName="mobile" class="mt-1 block w-full border border-gray-300 rounded-md shadow-sm py-2 px-3 focus:outline-none focus:ring-indigo-500 focus:border-indigo-500">
              </div>
              <div>
                <label for="projectImage" class="block text-sm font-medium text-gray-700">Project Image</label>
                @if (imagePreview()) {
                    <div class="mt-2 relative group">
                        <img [src]="imagePreview()" alt="Project Preview" class="rounded-lg shadow-sm object-cover h-40 w-full">
                        <button (click)="removeImage()" type="button" class="absolute top-2 right-2 bg-red-500 text-white rounded-full p-1 h-6 w-6 flex items-center justify-center opacity-0 group-hover:opacity-100 transition-opacity">
                            <svg xmlns="http://www.w3.org/2000/svg" class="h-4 w-4" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12" /></svg>
                        </button>
                    </div>
                } @else {
                    <input id="projectImage" type="file" (change)="onFileChange($event)" accept="image/*" class="mt-1 block w-full text-sm text-gray-500 file:mr-4 file:py-2 file:px-4 file:rounded-full file:border-0 file:text-sm file:font-semibold file:bg-indigo-50 file:text-indigo-700 hover:file:bg-indigo-100">
                }
              </div>
            </div>
            <div class="mt-8 flex justify-end space-x-3">
              <button type="button" (click)="closeEditModal()" class="bg-gray-200 text-gray-800 px-4 py-2 rounded-md hover:bg-gray-300">Cancel</button>
              <button type="submit" [disabled]="projectForm.invalid" class="bg-indigo-600 text-white px-4 py-2 rounded-md hover:bg-indigo-700 disabled:bg-indigo-300">Save Changes</button>
            </div>
          </form>
        </div>
      </div>
    }

    <!-- Delete Project Modal -->
    @if (isDeleteModalOpen()) {
      <div class="fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50 animate-fade-in-fast">
        <div class="bg-white rounded-lg shadow-2xl p-8 w-full max-w-md mx-4" (click)="$event.stopPropagation()">
          <h3 class="text-2xl font-bold text-red-600 mb-4">Delete Project</h3>
          <p class="text-gray-600 mb-6">
            Are you sure you want to permanently delete this project? All associated entries will also be deleted. This action cannot be undone.
          </p>
          <form [formGroup]="deleteConfirmationForm" (ngSubmit)="deleteProject()">
            <label for="delete-confirm" class="block text-sm font-medium text-gray-700">
              To confirm, please type "<strong class="text-gray-900">delete project {{ p.name }}</strong>" below:
            </label>
            <input id="delete-confirm" type="text" formControlName="confirmationText" class="mt-1 block w-full border border-gray-300 rounded-md shadow-sm py-2 px-3 focus:outline-none focus:ring-red-500 focus:border-red-500" autocomplete="off">
            
            <div class="mt-8 flex justify-end space-x-3">
              <button type="button" (click)="closeDeleteModal()" class="bg-gray-200 text-gray-800 px-4 py-2 rounded-md hover:bg-gray-300">Cancel</button>
              <button type="submit" [disabled]="deleteConfirmationForm.invalid" class="bg-red-600 text-white px-4 py-2 rounded-md hover:bg-red-700 disabled:bg-red-300">Delete Project</button>
            </div>
          </form>
        </div>
      </div>
    }

  } @else {
    <div class="text-center py-20">
      <p class="text-gray-500 text-lg">Loading project details or project not found...</p>
    </div>
  }
</div>
